<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HealthSync AI Assistant</title>
    <style>
      :root {
        font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        color: #1f2933;
        background: linear-gradient(135deg, #e0f2ff 0%, #f8fbff 45%, #ffffff 100%);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 15px 80px;
        background: linear-gradient(135deg, #e0f2ff 0%, #f8fbff 45%, #ffffff 100%);
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .chat-wrapper {
        width: 100%;
        max-width: 900px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 28px;
        box-shadow: 0 20px 50px rgba(15, 23, 42, 0.12);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
      }

      .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 28px;
        background: #ffffff;
        border-bottom: 1px solid rgba(226, 232, 240, 0.8);
      }

      .chat-header h1 {
        margin: 0;
        font-size: 1.8rem;
        color: #2c3e50;
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        border-radius: 999px;
        background: rgba(39, 174, 96, 0.12);
        color: #27ae60;
        font-weight: 600;
        font-size: 0.95rem;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #27ae60;
        box-shadow: 0 0 10px rgba(39, 174, 96, 0.6);
      }

      .chat-body {
        flex: 1;
        padding: 32px;
        background: linear-gradient(180deg, rgba(248, 250, 252, 0.7), rgba(255, 255, 255, 0.95));
        overflow-y: auto;
        scroll-behavior: smooth;
      }

      .chat-body::-webkit-scrollbar {
        width: 10px;
      }

      .chat-body::-webkit-scrollbar-thumb {
        background-color: rgba(148, 163, 184, 0.4);
        border-radius: 999px;
      }

      .message {
        max-width: 75%;
        padding: 18px 22px;
        margin: 15px 0;
        border-radius: 20px;
        font-size: 1rem;
        line-height: 1.6;
        animation: fadeIn 0.35s ease;
      }

      .message.ai {
        background: #f5f7fa;
        color: #4a5568;
        border-top-left-radius: 6px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      }

      .message.user {
        background: #ffffff;
        color: #2d3748;
        border: 1px solid rgba(226, 232, 240, 0.9);
        border-top-right-radius: 6px;
        margin-left: auto;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      }

      .timestamp {
        display: block;
        margin-top: 8px;
        font-size: 0.75rem;
        color: #a0aec0;
      }

      .typing-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #93a5b1;
        border-radius: 50%;
        animation: typing 1s infinite ease-in-out;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: 0.15s;
      }

      .typing-indicator span:nth-child(3) {
        animation-delay: 0.3s;
      }

      .input-area {
        position: sticky;
        bottom: 0;
        padding: 20px 24px 24px;
        background: #ffffff;
        border-top: 1px solid rgba(226, 232, 240, 0.8);
        box-shadow: 0 -10px 30px rgba(15, 23, 42, 0.06);
      }

      .input-form {
        position: relative;
        display: flex;
        align-items: center;
      }

      .chat-input {
        width: 100%;
        padding: 15px 80px 15px 20px;
        background: #f7fafc;
        border: none;
        border-radius: 30px;
        font-size: 1rem;
        color: #1f2933;
        box-shadow: inset 0 2px 6px rgba(148, 163, 184, 0.2);
      }

      .chat-input:focus {
        outline: 2px solid rgba(59, 130, 246, 0.35);
      }

      .submit-btn {
        position: absolute;
        right: 8px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: none;
        background: #3b82f6;
        color: #ffffff;
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.2s ease, background 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 12px 25px rgba(59, 130, 246, 0.35);
      }

      .submit-btn:hover:not(:disabled) {
        background: #2563eb;
      }

      .submit-btn:active:not(:disabled) {
        transform: scale(0.96);
      }

      .submit-btn:disabled {
        background: rgba(59, 130, 246, 0.5);
        cursor: not-allowed;
      }

      .error-banner {
        margin-top: 16px;
        padding: 12px 16px;
        border-radius: 16px;
        background: rgba(255, 68, 68, 0.1);
        color: #b91c1c;
        font-size: 0.95rem;
        display: none;
      }

      .disclaimer {
        padding: 16px 28px 28px;
        color: #6b7280;
        font-size: 0.9rem;
        background: rgba(248, 250, 252, 0.8);
        border-top: 1px solid rgba(226, 232, 240, 0.8);
      }

      .disclaimer strong {
        color: #2f3d4a;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes typing {
        0%, 80%, 100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-6px);
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 20px 12px 60px;
        }

        .chat-wrapper {
          border-radius: 20px;
        }

        .chat-header {
          flex-direction: column;
          gap: 10px;
        }

        .message {
          max-width: 90%;
        }
      }
    </style>
  </head>
  <body>
    <main class="chat-wrapper" aria-live="polite">
      <section class="chat-header">
        <div>
          <h1>AI Assistant</h1>
          <p style="margin: 4px 0 0; color: #7b8794;">Virtual medical support • Compassionate & secure</p>
        </div>
        <div class="status-pill" aria-label="Assistant status: online">
          <span class="status-dot"></span>
          Online
        </div>
      </section>

      <section id="chatBody" class="chat-body" role="log" aria-live="polite" aria-label="Chat messages"></section>

      <div class="input-area" role="form">
        <form id="chatForm" class="input-form" autocomplete="off">
          <label for="chatInput" class="sr-only">Describe your symptoms</label>
          <input
            id="chatInput"
            class="chat-input"
            name="message"
            type="text"
            minlength="2"
            placeholder="Type your symptoms..."
            aria-label="Type your symptoms"
            required
          />
          <button id="submitBtn" class="submit-btn" type="submit" aria-label="Send message">
            →
          </button>
        </form>
        <div id="errorBanner" class="error-banner" role="alert"></div>
      </div>

      <footer class="disclaimer">
        <strong>Privacy Notice:</strong> This chatbot stores recent conversation history locally for your convenience. Sensitive medical details are not transmitted beyond your current session. Always consult a licensed healthcare professional for personalized medical advice.
      </footer>
    </main>

    <script>
      // --- Configuration ----------------------------------------------------
      const API_KEY = 'AIzaSyBjTSuslIdp7_gzsZdK5KkzsRtM6JNq40Y';
      const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';
      const MAX_TOKENS = 500;
      const TEMPERATURE = 0.7;
      const LOCAL_STORAGE_KEY = 'healthsync_ai_chat_history';

      const systemPrompt = [
        'You are HealthSync AI, a compassionate virtual medical assistant. Follow these rules:',
        '• Greet users warmly and gather initial symptoms.',
        '• Ask one targeted follow-up question at a time (duration, severity, associated symptoms, history, medication, lifestyle).',
        '• Offer balanced, empathetic language. Acknowledge concerns.',
        '• NEVER provide a definitive diagnosis or prescribe medication.',
        '• Provide general health education and possible considerations.',
        '• Always advise seeking professional care for urgent or serious symptoms.',
        '• Include gentle reminders that you are not a substitute for a doctor.',
        '• Encourage healthy lifestyle habits where appropriate.',
        '• Keep responses concise (under 120 words) yet informative and friendly.'
      ].join('\n');

      // --- State ------------------------------------------------------------
      const chatBody = document.getElementById('chatBody');
      const chatForm = document.getElementById('chatForm');
      const chatInput = document.getElementById('chatInput');
      const submitBtn = document.getElementById('submitBtn');
      const errorBanner = document.getElementById('errorBanner');

      let conversationHistory = [];

      // Restore previous conversation if available
      const savedHistory = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (savedHistory) {
        try {
          const parsed = JSON.parse(savedHistory);
          if (Array.isArray(parsed) && parsed.length > 0) {
            conversationHistory = parsed;
            renderConversationFromHistory(parsed);
          } else {
            conversationHistory = [];
            addInitialGreeting();
          }
        } catch {
          conversationHistory = [];
          addInitialGreeting();
        }
      } else {
        addInitialGreeting();
      }

      function renderConversationFromHistory(history) {
        if (!history.length) {
          addInitialGreeting();
          return;
        }

        history.forEach((entry) => {
          const text = entry && entry.parts && entry.parts[0] ? entry.parts[0].text || '' : '';
          if (entry.role === 'user') {
            addMessageToChat(text, 'user', false);
          } else if (entry.role === 'model') {
            addMessageToChat(text, 'ai', false);
          }
        });
      }

      function addInitialGreeting() {
        const greeting = 'How can I help you with your health concerns today?';
        const greetingEntry = { role: 'model', parts: [{ text: greeting }] };
        conversationHistory.push(greetingEntry);
        addMessageToChat(greeting, 'ai');
        persistHistory();
      }

      // --- Helpers ----------------------------------------------------------
      function addMessageToChat(text, sender = 'ai', shouldScroll = true) {
        const message = document.createElement('div');
        message.className = 'message ' + (sender === 'ai' ? 'ai' : 'user');
        message.innerHTML = parseMarkdown(text);

        const timeStamp = document.createElement('span');
        timeStamp.className = 'timestamp';
        timeStamp.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        message.appendChild(timeStamp);

        chatBody.appendChild(message);

        if (shouldScroll) {
          chatBody.scrollTop = chatBody.scrollHeight;
        }
      }

      function showTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'message ai typing';
        indicator.id = 'typingIndicator';
        indicator.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
        chatBody.appendChild(indicator);
        chatBody.scrollTop = chatBody.scrollHeight;
      }

      function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
          chatBody.removeChild(indicator);
        }
      }

      function parseMarkdown(text) {
        if (!text) return '';
        let parsed = text
          .replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>')
          .replace(/\\*(.*?)\\*/g, '<em>$1</em>')
          .replace(/`([^`]+)`/g, '<code>$1</code>');

        const listItemPattern = new RegExp('^-\\s(.*$)', 'gim');
        parsed = parsed.replace(listItemPattern, '<li>$1</li>');
        const listWrapperPattern = new RegExp('(<li>.*</li>)', 'gim');
        parsed = parsed.replace(listWrapperPattern, '<ul>$1</ul>');
        parsed = parsed.replace(/\\n/g, '<br />');
        return parsed;
      }

      function setLoadingState(isLoading) {
        submitBtn.disabled = isLoading;
        chatInput.disabled = isLoading;
      }

      function showError(message) {
        errorBanner.textContent = message;
        errorBanner.style.display = 'block';
        setTimeout(() => {
          errorBanner.style.display = 'none';
        }, 5000);
      }

      function persistHistory() {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(conversationHistory.slice(-20)));
      }

      async function sendMessageToGemini(history) {
        const requestBody = {
          contents: history,
          systemInstruction: {
            role: 'user',
            parts: [{ text: systemPrompt }]
          },
          generationConfig: {
            temperature: TEMPERATURE,
            maxOutputTokens: MAX_TOKENS,
            topP: 0.95,
            topK: 32,
          }
        };

        const response = await fetch(API_URL + '?key=' + API_KEY, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          let parsedError = {};
          try {
            parsedError = await response.json();
          } catch {
            parsedError = {};
          }
          const apiMessage =
            parsedError &&
            parsedError.error &&
            parsedError.error.message
              ? parsedError.error.message
              : 'API request failed';
          const error = new Error(apiMessage);
          error.status = response.status;
          throw error;
        }

        return response.json();
      }

      // --- Form Submission --------------------------------------------------
      chatForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const userInput = chatInput.value.trim();

        if (userInput.length < 2) {
          showError('Please enter at least two characters so I can assist you better.');
          return;
        }

        addMessageToChat(userInput, 'user');
        chatInput.value = '';
        chatInput.focus();

        conversationHistory.push({ role: 'user', parts: [{ text: userInput }] });
        persistHistory();

        showTypingIndicator();
        setLoadingState(true);
        hideError();

        try {
          const data = await sendMessageToGemini(conversationHistory);
          const aiParts =
            data &&
            data.candidates &&
            data.candidates[0] &&
            data.candidates[0].content &&
            Array.isArray(data.candidates[0].content.parts)
              ? data.candidates[0].content.parts
              : [];

          const aiResponse = aiParts.length
            ? aiParts
                .map((part) => (part && part.text ? part.text : ''))
                .join('')
                .trim() || "I'm experiencing technical difficulties. Please try again in a moment."
            : "I'm experiencing technical difficulties. Please try again in a moment.";

          removeTypingIndicator();
          addMessageToChat(aiResponse, 'ai');

          conversationHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
          persistHistory();
        } catch (error) {
          removeTypingIndicator();
          handleError(error);
        } finally {
          setLoadingState(false);
        }
      });

      function hideError() {
        errorBanner.textContent = '';
        errorBanner.style.display = 'none';
      }

      function handleError(error) {
        console.error(error);
        let message = "I'm experiencing technical difficulties. Please try again in a moment.";

        if (error.status === 429) {
          message = 'I am processing many requests right now. Please wait a few seconds before trying again.';
        } else if (error.status === 0 || error.message.includes('Failed to fetch')) {
          message = "Sorry, I'm having trouble connecting. Please check your internet and try again.";
        }

        showError(message);
        addMessageToChat(message, 'ai');
      }

      // Accessibility: allow Enter to submit, Shift+Enter for newline
      chatInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          chatForm.dispatchEvent(new Event('submit'));
        }
      });
    </script>
  </body>
</html>

